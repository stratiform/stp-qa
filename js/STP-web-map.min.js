/*! STP-web-map 24-05-2018 */

var vers="0.0.2";console.log("STP Web Map version "+vers);var map,stateControl,programControl,linkDict,histLinkDict,lookupDict,featureControl,layers={emet_data:{layer:null,raw:null},emet_connex:{layer:null,raw:null},display:{layer:null}},groups={ACT:"NSW"},account="acem",presetBounds={ACT:L.latLngBounds(L.latLng(-35.1086749645,148.7397766113),L.latLng(-35.9457711607,149.4827270508)),NSW:L.latLngBounds(L.latLng(-27.8585039548,140.5261230469),L.latLng(-37.6490340216,154.1162109375)),VIC:L.latLngBounds(L.latLng(-33.6146192923,140.625),L.latLng(-39.3342974298,150.3369140625)),SA:L.latLngBounds(L.latLng(-25.5424414701,128.5620117188),L.latLng(-38.6511983323,141.50390625)),QLD:L.latLngBounds(L.latLng(-10.1419316861,137.28515625),L.latLng(-29.3821750751,154.9072265625)),TAS:L.latLngBounds(L.latLng(-39.1300602421,143.1958007812),L.latLng(-43.9611906389,149.5458984375)),WA:L.latLngBounds(L.latLng(-12.8546489056,111.4892578125),L.latLng(-36.2088230928,129.0673828125)),NT:L.latLngBounds(L.latLng(-10.1419316861,128.3642578125),L.latLng(-26.3918696718,138.4716796875)),all:L.latLngBounds(L.latLng(-9.7090570686,111.26953125),L.latLng(-43.8662180066,155.2587890625))},colours={hub:{curr:"#A51140"},site:{curr:"#556013"},connex:{curr:"#132030",hist:"#4D83C4"}},stpColours={STPS:{hub:"#26A7DE"},IRTP:{hub:"#A51140",site:"#556013"},EDPSCS:{hub:"#d95f02"},TAS:{hub:"#7570b3"}},toggleObj={emet_hub_or_training_site:"all",emet_connex:!1,historical:null};$("#sidebar-content").css("opacity","0").toggle("slide",{direction:"right"},0,function(){$("#sidebar-content").css("opacity","1")});var slid=!1,searchControl=new L.control.fuseSearch({position:"bottomleft",placeholder:"Search hospitals...",panelTitle:"Search EMET hospitals",maxResultLength:10,threshold:.25,title:"Search"}),stpsIcon=L.icon({iconUrl:"img/map_icons/stps-icon.png",iconAnchor:[6.5,6.5],labelAnchor:null}),irtpHubIcon=L.icon({iconUrl:"img/map_icons/irtp-hub-icon.png",iconAnchor:[6.5,6.5],labelAnchor:null}),irtpSiteIcon=L.icon({iconUrl:"img/map_icons/irtp-site-icon.png",iconAnchor:[6.5,6.5],labelAnchor:null}),edpscsIcon=L.icon({iconUrl:"img/map_icons/edpscs-icon.png",iconAnchor:[6.5,6.5],labelAnchor:null}),tasIcon=L.icon({iconUrl:"img/map_icons/tas-icon.png",iconAnchor:[6.5,6.5],labelAnchor:null});function _lineStyle(e){var t={weight:1.5,opactiy:.9};return t.color=null!=e.properties.historical?colours.connex.hist:colours.connex.curr,t}var onEachMarker=function(e,t){return e.properties.state in groups&&(e.properties.state=groups[e.properties.state]),"VIC"==e.properties.state||"NT"==e.properties.state?L.marker(t,{icon:stpsIcon,title:e.properties.hospital_name}).setZIndexOffset(50):"NSW"==e.properties.state||"SA"==e.properties.state?L.marker(t,{icon:edpscsIcon,title:e.properties.hospital_name}).setZIndexOffset(50):"QLD"==e.properties.state||"WA"==e.properties.state?"EMET Training Site"==e.properties.emet_hub_or_training_site?L.marker(t,{icon:irtpSiteIcon,title:e.properties.hospital_name}).setZIndexOffset(50):L.marker(t,{icon:irtpHubIcon,title:e.properties.hospital_name}).setZIndexOffset(100):"TAS"==e.properties.state?L.marker(t,{icon:tasIcon,title:e.properties.hospital_name}).setZIndexOffset(50):void 0},onEachFeature=function(e,t){t.on({click:triggerClickEvents})},EmetControl=L.Control.extend({cssClasses:["leaflet-bar","emet-control"],htmlString:"",onAdd:function(){var e=L.DomUtil.create("div",this.cssClasses.join(" "));return e.innerHTML=this.htmlString,L.DomEvent.disableClickPropagation(e),e}}),emetGeoJSON=L.GeoJSON.extend({setPointType:function(e){e.feature.pointType="EMET Training Site"==e.feature.properties.emet_hub_or_training_site?"site":"hub",e.feature.layer=e},setMarkerType:function(e){},options:{pointToLayer:onEachMarker,onEachFeature:onEachFeature},onAdd:function(e){for(let t in this._layers)e.addLayer(this._layers[t]),this.setPointType(this._layers[t])}}),_geojsonNameLookup=function(e){var t={};for(let a=0;a<e.features.length;a++){t[e.features[a].properties.acem_id]=e.features[a].properties.hospital_name}return t},createInfoHTML=function(e,t,a,i){var r=null!=e.historical,o=e.historical_desc.length>0?e.historical_desc:null,n=e.historical_hub_acem_id,l=e.hospital_name,s=(r||e.emet_hub_or_training_site,e.description),c=(new Date(e.last_date).toLocaleDateString(),!!e.photo1&&e.photo1),d=!!e.photo2&&e.photo2,p=!!c&&c.replace("_thumb",""),h=!!d&&d.replace("_thumb",""),u="";let _=Math.floor(5*Math.random()),g=Math.floor(4*Math.random());var m;if(["VIC","NT"].indexOf(a)>-1?m="STPS":["NSW","SA"].indexOf(a)>-1?m="EDPSCS":["QLD","WA"].indexOf(a)>-1?m="IRTP":["TAS"].indexOf(a)>-1&&(m="TAS"),u+="<div class='sidebar-title' style='background-color: "+stpColours[m].hub+"'><h1 id='side-title'>"+l+"</h1></div>",u+="<div class='sidebar-top'><object type='image/svg+xml' data='img/state_icons/"+a+"-ICON.svg' id='state-icon'>State Logo</object><div class='title-text' style='background-color: "+stpColours[m].hub+"'><span>"+m+" Hospital</span></div></div>",u+="<p class='desc'>"+s+"</p>",u+="<div class='discipline'><h2>Discipline / specialty</h2><p>"+["Rural & Remote","ED / Anaesthetics","ED / ICU","Ultrasound","Critical Care (ICU or Anaesthetics)"][_]+"</p></div>",u+="<div class='discipline'><h2>Remoteness</h2><p>"+["RA1","RA2","RA3","RA4"][g]+"</p></div>",null!=o&&(u+="<p class='desc'>"+o+"</p>"),u+="<div class='hosp-list'>","site"!=t||r)if("site"==t&&r)u+="<h2>"+i.site.historical+"</h2>",u+="<ul><li>"+e.linked_emet_hub+"</li></ul>",e.secondary_linked_hub&&(u+="<ul><li>"+e.secondary_linked_hub+"</li></ul>");else if("hub"!=t||r){if("hub"==t&&r){u+="<h2>"+i.hub.historical+"</h2>",u+="<ul>";for(let t=0;t<histLinkDict[e.acem_id].length;t++)u+="<li>"+histLinkDict[e.acem_id][t]+"</li>";u+="</ul>"}}else{u+="<h2>"+i.hub.heading+"</h2>",u+="<ul>";for(let t=0;t<linkDict[e.acem_id].length;t++)u+="<li>"+linkDict[e.acem_id][t]+"</li>";if(u+="</ul>",histLinkDict[e.acem_id]){u+="<h2>"+i.hub.historical+"</h2>",u+="<ul>";for(let t=0;t<histLinkDict[e.acem_id].length;t++)u+="<li>"+histLinkDict[e.acem_id][t]+"</li>";u+="</ul>"}}else u+="<h2>"+i.site.heading+"</h2>",u+="<ul><li>"+e.linked_emet_hub+"</li></ul>",e.secondary_linked_hub&&(u+="<ul><li>"+e.secondary_linked_hub+"</li></ul>"),n&&(u+="<h2>"+i.site.historical+"</h2>",u+="<ul><li>"+lookupDict[n]+"</li></ul>");return u+="</div>",e.photo1&&(u+=e.photo2?"<div id='view-images'><img dest='"+p+"' src='"+c+"' /><img dest='"+h+"' src='"+d+"' /></div>":"<div id='view-images'><img dest='"+p+"' src='"+c+"' /></div>"),e.email?(e.url?u+="<p class='foot'>"+i.contact+"<br> <a href='"+e.url+"'>"+e.url+"</a><br>":u+="<p class='foot'>"+i.contact+"<br>",u+="<a href='mailto:"+e.email+"'>"+e.email+"</a></p>"):u+="<p class='foot'>"+i.contact+" <br> <a href='mailto:EMET@acem.org.au'>EMET@acem.org.au</a></p>",u+=""},createLinkDict=function(e){var t={};for(let a in e.features){let i=e.features[a].properties,r=i.emet_hub_or_training_site,o=i.linked_emet_hub_acem_id,n=i.secondary_hub_acem_id,l=i.hospital_name,s=i.acem_id;null!=i.historical||("EMET Training Site"==r?(o in t?t[o].push(l):t[o]=[l],n in t?t[n].push(l):t[n]=[l]):t[s]||(t[s]=[]))}return t},createHistLinkDict=function(e){var t={};for(let a in e.features){let i=e.features[a].properties,r=i.emet_hub_or_training_site,o=i.historical_hub_acem_id,n=null!=i.historical&&i.linked_emet_hub_acem_id,l=null!=i.historical&&i.secondary_hub_acem_id,s=i.hospital_name,c=i.acem_id;"EMET Training Site"==r?(o in t?t[o].push(s):t[o]=[s],n&&n in t?t[n].push(s):t[n]=[s],l&&l in t?t[l].push(s):t[l]=[s]):t[c]||(t[c]=[])}return t},updateInfoWindow=function(e,t){var a=e.target.feature.properties,i="EMET Training Site"==e.target.feature.properties.emet_hub_or_training_site?"site":"hub",r=a.state;var o;["VIC","NT"].indexOf(r)>-1?o="STPS":["NSW","SA"].indexOf(r)>-1?o="EDPSCS":["QLD","WA"].indexOf(r)>-1?o="IRTP":["TAS"].indexOf(r)>-1&&(o="TAS");var n=$(window).height()-$("#legend").height();$("#"+t).removeClass().addClass(o).html(createInfoHTML(a,i,r,sidebarText)).css("height",n),$("#state-icon").on("load",function(){let e=$("#state-icon").getSVG().find("#highlight polygon");e.removeClass(),e.attr("fill",_getSidebarColour());let t=$("#state-icon").css("height");$(".title-text").css("height",t)});$("#view-images").viewer({toolbar:!1,movable:!1,zoomable:!1,rotatable:!1,scalable:!1,title:!1,url:"dest"})},_getSidebarColour=function(){let e=$("#sidebar-content").attr("class");return stpColours[e].hub},_resizeSidebar=function(){var e=$(window).height()-$("#legend").height();$("#sidebar-content").css("height",e)},_showHistoricalLegend=function(){$(".legend-historical").css("display","table-row"),_resizeSidebar()},_hideHistoricalLegend=function(){$(".legend-historical").css("display","none"),_resizeSidebar()},_featureInDisplay=function(e){var t=!1;return layers.display.eachLayer(function(a){a.feature.properties.acem_id==e&&(t=!0)}),t},triggerClickEvents=function(e){(jQuery.isEmptyObject(linkDict)||jQuery.isEmptyObject(histLinkDict)||jQuery.isEmptyObject(lookupDict))&&(linkDict=createLinkDict(layers.emet_data.raw),histLinkDict=createHistLinkDict(layers.emet_data.raw),lookupDict=_geojsonNameLookup(layers.emet_data.raw)),updateInfoWindow(e,"sidebar-content"),map.closePopup(),layers.emet_data.layer.unbindLabel();var t="EMET Hub"==e.target.feature.properties.emet_hub_or_training_site?"hub":"site",a=!1;if(layers.display.getLayers().length>0&&_featureInDisplay(e.target.feature.properties.acem_id)&&(a=$.extend({},e.target.feature)),_resetLayers(!1),!toggleObj.emet_connex&&"all"==toggleObj.emet_hub_or_training_site){var i=!1;for(let a in layers.emet_connex.raw.features){let r=layers.emet_connex.raw.features[a],o=r.properties.acem_id,n=e.target.feature.properties.acem_id,l=t,s=r.properties.linked_emet_hub_acem_id,c=r.properties.secondary_hub_acem_id,d=r.properties.hub_id,p=r.properties.historical;if("site"==l){if(o==n||s==n||c==n){let e={type:"FeatureCollection",features:[r]};p&&(i=p),layers.emet_connex.layer.addData(e)}}else if((s==n||c==n)&&n==d){let e={type:"FeatureCollection",features:[r]};p&&(i=p),layers.emet_connex.layer.addData(e)}}}i?_showHistoricalLegend():_hideHistoricalLegend();for(let t in layers.emet_data.raw.features)if("all"==toggleObj.emet_hub_or_training_site){let i=layers.emet_data.raw.features[t];if($.inArray(i.properties.hospital_name,linkDict[e.target.feature.properties.acem_id])>-1||$.inArray(i.properties.hospital_name,histLinkDict[e.target.feature.properties.acem_id])>-1){let e={type:"FeatureCollection",features:a?[i,a]:[i]};layers.display.addData(e)}else if(e.target.feature.properties.linked_emet_hub_acem_id==i.properties.acem_id||e.target.feature.properties.secondary_hub_acem_id==i.properties.acem_id||e.target.feature.properties.historical_hub_acem_id==i.properties.acem_id){let e={type:"FeatureCollection",features:a?[i,a]:[i]};layers.display.addData(e)}}layers.display.eachLayer(function(e){e.bindLabel(e.feature.properties.hospital_name.replace(/([\w\s]{20,}?)\s?\b/g,"$1\n"),{noHide:!0,opacity:1,pane:"popupPane",direction:"auto"}).showLabel();let t="EMET Hub"==e.feature.properties.emet_hub_or_training_site?"hub":"site";"site"==t&&$(e.label._container).addClass("site-label"),"hub"==t&&$(e.label._container).addClass("hub-label")}),slid||($("#sidebar-content").toggle("slide",{direction:"right"}).css("opacity","1"),slid=!0),e.target.bindLabel(e.target.feature.properties.hospital_name.replace(/([\w\s]{20,}?)\s?\b/g,"$1\n"),{noHide:!0,opacity:1,pane:"popupPane",direction:"auto"}).showLabel(),"site"==t?$(e.target.label._container).addClass("site-label"):"hub"==t&&$(e.target.label._container).addClass("hub-label")},filterFeatures=function(e,t,a,i,r,o,n,l,s,c){var d;d="id"==e?"#":"class"==e?".":null===e?"":"#",c?$(d+t).change(function(){filterExec($(this).prop(r),a,i,r,o,n,l,s,c)}):$(d+t).click(function(){filterExec($(this).prop(r),a,i,r,o,n,l,s,c)})},filterExec=function(e,t,a,i,r,o,n,l,s){l&&("all"!=e||toggleObj[a]?"none"==e&&($(this).prop(i,"all"),toggleObj[a]=!1):($(this).prop(i,"none"),toggleObj[a]=!0)),("connex"!=e&&"emet_hub_or_training_site"==t||"historical"===t)&&(toggleObj.emet_connex=!1),"historical"===t&&_showHistoricalLegend(),"historical"!==t&&_hideHistoricalLegend(),"connex"!=e||toggleObj.emet_connex||(layers.emet_connex.layer.setStyle(function(e){return toggleObj.state&&toggleObj.state!=e.properties.state?{opacity:0}:{opacity:1}}),e="all",toggleObj.emet_connex=!0),"emet_hub_or_training_site"==t&&"connex"!=e&&(toggleObj[t]=e),"historical"==t?(toggleObj[t]="Y",toggleObj.emet_hub_or_training_site="all"):"state"!=t&&(toggleObj.historical=null),"state"==t&&(slid&&($("#sidebar-content").toggle("slide",{direction:"right"}),slid=!1),"all"!=e?toggleObj[t]=e:delete toggleObj[t]),console.log("filterProp: ",t,"toggleObj: ",toggleObj),_filterData(!0,!0),o&&_reindexFeatures(layers.emet_data.filtering,["hospital_name","suburb","state"]),_resetLayers(),n&&map.fitBounds(presetBounds[e])};function _resetLayers(e){(e=void 0===e||e)?(layers.emet_data.layer.clearLayers(),layers.emet_connex.layer.clearLayers(),layers.display.clearLayers(),layers.emet_data.filtering?layers.emet_data.layer.addData(layers.emet_data.filtering):layers.emet_data.layer.addData(layers.emet_data.raw),layers.emet_connex.filtering?layers.emet_connex.layer.addData(layers.emet_connex.filtering):layers.emet_connex.layer.addData(layers.emet_connex.raw)):(layers.emet_connex.layer.clearLayers(),layers.display.clearLayers(),layers.emet_connex.filtering?layers.emet_connex.layer.addData(layers.emet_connex.filtering):layers.emet_connex.layer.addData(layers.emet_connex.raw))}function _reindexFeatures(e,t){searchControl.indexFeatures(e,t)}function _featFilter(e,t){var a=[];for(let t in toggleObj){let i=toggleObj[t];"emet_connex"==t&&"points"==this||("emet_hub_or_training_site"==t&&"connex"==this||("emet_hub_or_training_site"==t&&"all"==i?a.push(!0):"emet_connex"==t&&i?a.push(!0):"emet_hub_or_training_site"==t&&"all"==i?a.push(!0):"historical"==t&&"Y"==i?a.push(!0):i==e.properties[t]?a.push(!0):a.push(!1)))}return a=!(a.indexOf(!1)>-1)}function _filterData(e,t){e&&(layers.emet_data.filtering={},layers.emet_data.filtering={type:"FeatureCollection",features:layers.emet_data.raw.features.filter(_featFilter,"points")},console.log("point feats: ",layers.emet_data.filtering.features.length+" of "+layers.emet_data.raw.features.length)),t&&(layers.emet_connex.filtering={},layers.emet_connex.filtering={type:"FeatureCollection",features:layers.emet_connex.raw.features.filter(_featFilter,"connex")},console.log("connex feats: ",layers.emet_connex.filtering.features.length+" of "+layers.emet_connex.raw.features.length))}var getCartoJSON=function(e,t,a,i){i=i||"SELECT * FROM "+t,t="emet_data_dev"===t?"emet_data":t,$.getJSON("https://"+e+".carto.com/api/v2/sql/?q="+i+"&format=geojson",function(e){if(e.features[0].geometry&&"Point"==e.features[0].geometry.type)layers[t].raw=e,_filterData(!0,!1),layers[t].layer=new emetGeoJSON(layers.emet_data.filtering),searchControl.indexFeatures(layers.emet_data.filtering,["hospital_name","suburb","state"]),layers[t].layer.addTo(a);else if(e.features[0].geometry&&"LineString"==e.features[0].geometry.type){let i=JSON.stringify((new Date).getFullYear()).substring(2);layers[t].raw=e,layers[t].layer=new emetGeoJSON({type:"FeatureCollection",features:[]},{style:_lineStyle,attribution:"Â© 2017-"+i+" <a href='https://www.acem.org.au/' target='blank'>ACEM</a>"}).addTo(a)}}).done(function(){layers.emet_data.layer&&layers.emet_connex.layer&&(console.log("...Data received"),a.spin(!1),_filterData(!0,!0))})},createMap=function(){var e=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png",{attribution:"&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"});(map=new L.Map("map",{layers:[e],zoomControl:!1}).on("click",function(){slid&&($("#sidebar-content").toggle("slide",{direction:"right"}),slid=!1),!toggleObj.historical&&$(".legend-historical").css("display","table-row")&&_hideHistoricalLegend(),_resetLayers()})).spin(!0),map.fitBounds(presetBounds.all),searchControl.options.mapObj=map,searchControl.addTo(map),L.control.zoom({position:"bottomleft"}).addTo(map);var t="";t+="<h3>Layers</h3>",t+="<input type='radio' name='point-filter' value='EMET Hub' class='hubs'> STP Hubs<br>",t+="<input type='radio' name='point-filter' value='all' checked class='hubs'> All Hubs and Training Sites<br>",t+="<input type='radio' name='point-filter' value='connex' class='hubs'> STP Hubs and Training Sites with connections<br>",(featureControl=new EmetControl({position:"topleft"})).htmlString=t,featureControl.addTo(map),featureControl.getContainer().className+=" feature-control",filterFeatures(null,"input[type='radio'][name='point-filter'].hubs","emet_hub_or_training_site","emet_data","value",!0,!0,!1,!1,!0),filterFeatures(null,"input[type='radio'][name='point-filter'].historical","historical","emet_data","value",!0,!0,!1,!1,!0),stateControl=new EmetControl({position:"topleft"});var a="";a+="<a href='#' id='all' class='dropdown-selection'>Show all states</a>",a+="<a href='#' id='NSW' class='dropdown-selection'>NSW & ACT</a>",a+="<a href='#' id='NT' class='dropdown-selection'>NT</a>",a+="<a href='#' id='QLD' class='dropdown-selection'>QLD</a>",a+="<a href='#' id='SA' class='dropdown-selection'>SA</a>",a+="<a href='#' id='TAS' class='dropdown-selection'>TAS</a>",a+="<a href='#' id='VIC' class='dropdown-selection'>VIC</a>",a="<div class='dropdown'>"+(a="<h3 class='dropdown-label'>State</h3>"+(a="<button class='dropbtn'>Filter by state        &#x25BC;</button>"+(a="<div class='dropdown-content'>"+(a+="<a href='#' id='WA' class='dropdown-selection'>WA</a>")+"</div>")))+"</div>",stateControl.htmlString=a,stateControl.addTo(map),stateControl.getContainer().className+=" state-control",filterFeatures("class","dropdown-selection","state","emet_data","id",!0,!0,!0,!1,!1),programControl=new EmetControl({position:"topleft"});var i="";i+="<a href='#' id='all' class='dropdown-selection'>Show all</a>",i+="<a href='#' id='STPS' class='dropdown-selection'>STPS</a>",i+="<a href='#' id='IRTP' class='dropdown-selection'>IRTP</a>",i+="<a href='#' id='EDPSCS' class='dropdown-selection'>EDPSCS</a>",i="<div class='dropdown'>"+(i="<h3 class='dropdown-label'>Program</h3>"+(i="<button class='dropbtn'>Filter by program        &#x25BC;</button>"+(i="<div class='dropdown-content'>"+(i+="<a href='#' id='TAS' class='dropdown-selection'>TAS</a>")+"</div>")))+"</div>",programControl.htmlString=i,programControl.addTo(map),programControl.getContainer().className+=" program-control";var r=new EmetControl({position:"topleft"});r.htmlString='<input id="labelToggle" type="checkbox" checked class="on">Labels</input>',r.addTo(map),r.getContainer().className+=" label-control",$("#labelToggle").change(function(){if($(this).hasClass("on")){$(this).toggleClass("on");var e=$('<style class="hack-style">.leaflet-label { display: none; }</style>');$("html > head").append(e)}else $(this).toggleClass("on"),$(".hack-style").remove()}),$(".dropdown").click(function(){"none"==$(this).children(".dropdown-content").css("display")?$(this).children(".dropdown-content").show():$(this).children(".dropdown-content").hide()}),$(".dropdown-selection").click(function(){$(this).parent().parent().children(".dropbtn").html("Showing: "+$(this).prop("id"))}),console.log("Getting data...");getCartoJSON(account,"emet_data",map),getCartoJSON(account,"emet_connex",map,"SELECT ed.acem_id as acem_id, case when (ed.historical_hub_acem_id is not null AND ed.historical_hub_acem_id = ec.acem_id) then ed.historical_hub_acem_id else ed.linked_emet_hub_acem_id end as linked_emet_hub_acem_id, ed.secondary_hub_acem_id as secondary_hub_acem_id, ST_GeomFromGeoJSON(CONCAT('{\"type\":\"LineString\",\"coordinates\":[[',ed.longitude, ', ', ed.latitude,'],[',ec.longitude, ', ', ec.latitude,']] }')) as the_geom, ec.acem_id as hub_id, ed.state as state, case when (ed.historical IS TRUE) then TRUE when (ec.historical IS TRUE) then TRUE  when (ed.historical_hub_acem_id is not null AND ed.historical_hub_acem_id = ec.acem_id) then TRUE else NULL end as historical FROM emet_data ed JOIN emet_data ec ON ed.linked_emet_hub_acem_id = ec.acem_id OR ed.secondary_hub_acem_id = ec.acem_id OR ed.historical_hub_acem_id = ec.acem_id");layers.display=new emetGeoJSON({type:"FeatureCollection",features:[]}).addTo(map)};window.onload=createMap;var sidebarText={contact:"For more information on this  program, contact:",site:{heading:"Serviced by:",historical:"Formerly serviced by:"},hub:{heading:"Servicing hospitals:",historical:"Formerly servicing hospitals:"}};