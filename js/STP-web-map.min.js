/*! STP-web-map 06-06-2018 */

var vers="0.0.7";console.log("STP Web Map version "+vers);var isIE=!!document.documentMode;String.prototype.titleCase=function(){return this.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})};var map,stateControl,programControl,linkDict,histLinkDict,lookupDict,featureControl,layers={stp_data:{layer:null,raw:null},connex:{layer:null,raw:null},display:{layer:null}},groups={ACT:"NSW"},account="acem",presetBounds={ACT:L.latLngBounds(L.latLng(-35.1086749645,148.7397766113),L.latLng(-35.9457711607,149.4827270508)),NSW:L.latLngBounds(L.latLng(-27.8585039548,140.5261230469),L.latLng(-37.6490340216,154.1162109375)),VIC:L.latLngBounds(L.latLng(-33.6146192923,140.625),L.latLng(-39.3342974298,150.3369140625)),SA:L.latLngBounds(L.latLng(-25.5424414701,128.5620117188),L.latLng(-38.6511983323,141.50390625)),QLD:L.latLngBounds(L.latLng(-10.1419316861,137.28515625),L.latLng(-29.3821750751,154.9072265625)),TAS:L.latLngBounds(L.latLng(-39.1300602421,143.1958007812),L.latLng(-43.9611906389,149.5458984375)),WA:L.latLngBounds(L.latLng(-12.8546489056,111.4892578125),L.latLng(-36.2088230928,129.0673828125)),NT:L.latLngBounds(L.latLng(-10.1419316861,128.3642578125),L.latLng(-26.3918696718,138.4716796875)),all:null},colours={STPS:{hub:"#26A7DE"},IRTP:{hub:"#A51140",site:"#556013"},EDPSCS:{hub:"#d95f02"},TAS:{hub:"#7570b3"},connex:{curr:"#132030",hist:"#4D83C4"}},toggleObj={emet_hub_or_training_site:"all",emet_connex:!1,historical:null},toggleInit=$.extend({},toggleObj),connexReceived=!1;$("#sidebar-content").css("opacity","0").toggle("slide",{direction:"right"},0,function(){$("#sidebar-content").css("opacity","1")});var slid=!1,searchControl=new L.control.fuseSearch({position:"bottomleft",placeholder:"Search hospitals...",panelTitle:"Search STP hospitals",maxResultLength:10,threshold:.25,title:"Search"}),stpsIcon=L.icon({iconUrl:"img/map_icons/stps-icon.png",iconAnchor:[8.5,9],labelAnchor:null}),irtpHubIcon=L.icon({iconUrl:"img/map_icons/irtp-hub-icon.png",iconAnchor:[8.5,9],labelAnchor:null}),irtpSiteIcon=L.icon({iconUrl:"img/map_icons/irtp-site-icon.png",iconAnchor:[8.5,9],labelAnchor:null}),edpscsIcon=L.icon({iconUrl:"img/map_icons/edpscs-icon.png",iconAnchor:[8.5,9],labelAnchor:null}),tasIcon=L.icon({iconUrl:"img/map_icons/tas-icon.png",iconAnchor:[8.5,9],labelAnchor:null});function _lineStyle(e){var t={weight:1.5,opactiy:.9};return t.color=null!=e.properties.historical?colours.connex.hist:colours.connex.curr,t}var onEachMarker=function(e,t){return e.properties.state in groups&&(e.properties.state=groups[e.properties.state]),"STPS"==e.properties.program?L.marker(t,{icon:stpsIcon,title:e.properties.hospital_name.titleCase()}).setZIndexOffset(50):"EDPSCS"==e.properties.program?L.marker(t,{icon:edpscsIcon,title:e.properties.hospital_name.titleCase()}).setZIndexOffset(50):"IRTP"==e.properties.program?"site"==e.properties.type?L.marker(t,{icon:irtpSiteIcon,title:e.properties.hospital_name.titleCase()}).setZIndexOffset(50):L.marker(t,{icon:irtpHubIcon,title:e.properties.hospital_name.titleCase()}).setZIndexOffset(100):"TAS"==e.properties.program?L.marker(t,{icon:tasIcon,title:e.properties.hospital_name.titleCase()}).setZIndexOffset(50):void 0},onEachFeature=function(e,t){t.on({click:triggerClickEvents})},EmetControl=L.Control.extend({cssClasses:["leaflet-bar","emet-control"],htmlString:"",onAdd:function(){var e=L.DomUtil.create("div",this.cssClasses.join(" "));return e.innerHTML=this.htmlString,L.DomEvent.disableClickPropagation(e),e}}),emetGeoJSON=L.GeoJSON.extend({setPointType:function(e){e.feature.pointType="EMET Training Site"==e.feature.properties.emet_hub_or_training_site?"site":"hub",e.feature.layer=e},setMarkerType:function(e){},options:{pointToLayer:onEachMarker,onEachFeature:onEachFeature},onAdd:function(e){for(var t in this._layers)e.addLayer(this._layers[t]),this.setPointType(this._layers[t])}}),_geojsonNameLookup=function(e){for(var t={},a=0;a<e.features.length;a++){t[e.features[a].properties.acem_id]=e.features[a].properties.hospital_name}return t},createInfoHTML=function(e,t,a,r){var i=null!=e.historical,o=e.historical_desc&&e.historical_desc.length>0?e.historical_desc:null,s=e.historical_hub_acem_id?e.historical_hub_acem_id:null,l=e.hospital_name.titleCase(),n=(i||e.emet_hub_or_training_site,e.description||null),c=e.specialty_discipline,p=e.ra_rating,d=e.rural_loading,u=(new Date(e.last_date).toLocaleDateString(),e.program);t=e.type,e.acem_id=e.stp_id;var g=!!e.photo1&&e.photo1,h=!!e.photo2&&e.photo2,_=!!g&&g.replace("_thumb",""),f=!!h&&h.replace("_thumb",""),b="";b+="<div class='sidebar-title' style='background-color: "+colours[u].hub+"'><h1 id='side-title'>"+l+"</h1></div>",b+="<div class='sidebar-top'><object type='image/svg+xml' data='img/state_icons/"+a+"-ICON.svg' id='state-icon'>State Logo</object><div class='title-text' style='background-color: "+colours[u].hub+"'><span>"+u+" Hospital</span></div></div>",n&&(b+="<p class='desc'>"+n+"</p>"),b+="<div class='discipline'><h2>Discipline / specialty</h2><p>"+c+"</p></div>";var y="<p><span>RA Rating:</span> "+p+"</p>";if(null!=d&&(y+="<p><span>Rural Loading:</span> "+d+"</p>"),b+="<div class='remote'><h2>Remoteness</h2>"+y+"</div>",null!=o&&(b+="<p class='desc'>"+o+"</p>"),e.linked_hub_id||linkDict[e.acem_id]||histLinkDict[e.acem_id])if(b+="<div class='hosp-list'>","site"!=t||i)if("site"==t&&i)b+="<h2>"+r.site.historical+"</h2>",b+="<ul><li>"+e.linked_emet_hub.titleCase()+"</li></ul>",e.secondary_linked_hub&&(b+="<ul><li>"+e.secondary_linked_hub.titleCase()+"</li></ul>");else if("hub"!=t||i){if("hub"==t&&i){b+="<h2>"+r.hub.historical+"</h2>",b+="<ul>";for(m=0;m<histLinkDict[e.acem_id].length;m++)b+="<li>"+histLinkDict[e.acem_id][m]+"</li>";b+="</ul>"}}else{b+="<h2>"+r.hub.heading+"</h2>",b+="<ul>";for(var m=0;m<linkDict[e.acem_id].length;m++)b+="<li>"+linkDict[e.acem_id][m]+"</li>";if(b+="</ul>",histLinkDict[e.acem_id]&&histLinkDict[e.acem_id].length>0){b+="<h2>"+r.hub.historical+"</h2>",b+="<ul>";for(var m=0;m<histLinkDict[e.acem_id].length;m++)b+="<li>"+histLinkDict[e.acem_id][m].titleCase()+"</li>";b+="</ul>"}}else b+="<h2>"+r.site.heading+"</h2>",b+="<ul><li>"+e.linked_hub_name.titleCase()+"</li></ul>",e.secondary_linked_hub&&(b+="<ul><li>"+e.secondary_linked_hub.titleCase()+"</li></ul>"),s&&(b+="<h2>"+r.site.historical+"</h2>",b+="<ul><li>"+lookupDict[s].titleCase()+"</li></ul>");return b+="</div>",e.photo1&&(b+=e.photo2?"<div id='view-images'><img dest='"+_+"' src='"+g+"' /><img dest='"+f+"' src='"+h+"' /></div>":"<div id='view-images'><img dest='"+_+"' src='"+g+"' /></div>"),e.email?(e.url?b+="<p class='foot'>"+r.contact+"<br> <a href='"+e.url+"'>"+e.url+"</a><br>":b+="<p class='foot'>"+r.contact+"<br>",b+="<a href='mailto:"+e.email+"'>"+e.email+"</a></p>"):b+="<p class='foot'>"+r.contact+" <br> <a href='mailto:EMET@acem.org.au'>EMET@acem.org.au</a></p>",b+=""},createLinkDict=function(e){var t={};for(var a in e.features){var r=e.features[a].properties,i=r.emet_hub_or_training_site?r.emet_hub_or_training_site:r.type,o=r.linked_hub_id,s=(r.secondary_hub_id,r.hospital_name),l=r.acem_id?r.acem_id:r.stp_id;null!=r.historical||("EMET Training Site"==i||o?o in t?t[o].push(s):t[o]=[s]:!t[l]&&i&&void 0!=l&&(t[l]=[]))}return t},createHistLinkDict=function(e){var t={};for(var a in e.features){var r=e.features[a].properties,i=r.emet_hub_or_training_site?r.emet_hub_or_training_site:r.type,o=r.historical_hub_acem_id,s=null!=r.historical&&r.linked_emet_hub_acem_id,l=null!=r.historical&&r.secondary_hub_acem_id,n=r.hospital_name,c=r.acem_id?r.acem_id:r.stp_id;"EMET Training Site"==i?(o in t?t[o].push(n):t[o]=[n],s&&s in t?t[s].push(n):t[s]=[n],l&&l in t?t[l].push(n):t[l]=[n]):!t[c]&&i&&(t[c]=[])}return t},updateInfoWindow=function(e,t){var a=e.target.feature.properties,r="EMET Training Site"==e.target.feature.properties.emet_hub_or_training_site?"site":"hub",i=a.state,o=a.program,s=$(window).height()-$("#legend").height();$("#"+t).removeClass().addClass(o).html(createInfoHTML(a,r,i,sidebarText)).css("height",s),$("#state-icon").on("load",function(){var e=$("#state-icon").getSVG().find("#highlight polygon");e.removeClass(),e.attr("fill",_getSidebarColour());var t=$("#state-icon").css("height");$(".title-text").css("height",t)});$("#view-images").viewer({toolbar:!1,movable:!1,zoomable:!1,rotatable:!1,scalable:!1,title:!1,url:"dest"})},_getSidebarColour=function(){var e=$("#sidebar-content").attr("class");return colours[e].hub},_resizeSidebar=function(){var e=$(window).height()-$("#legend").height();$("#sidebar-content").css("height",e)},_showHistoricalLegend=function(){$(".legend-historical").css("display","table-row"),_resizeSidebar()},_hideHistoricalLegend=function(){$(".legend-historical").css("display","none"),_resizeSidebar()},_featureInDisplay=function(e){var t=!1;return layers.display.eachLayer(function(a){a.feature.properties.stp_id==e&&(t=!0)}),t},triggerClickEvents=function(e){(jQuery.isEmptyObject(linkDict)||jQuery.isEmptyObject(histLinkDict)||jQuery.isEmptyObject(lookupDict))&&(linkDict=createLinkDict(layers.stp_data.raw),histLinkDict=createHistLinkDict(layers.stp_data.raw),lookupDict=_geojsonNameLookup(layers.stp_data.raw)),updateInfoWindow(e,"sidebar-content"),e.target.setZIndexOffset(1e3),map.closePopup(),layers.stp_data.layer.unbindLabel();var t="EMET Hub"==e.target.feature.properties.emet_hub_or_training_site?"hub":"site",a=!1,r=e.target.feature.properties.acem_id?e.target.feature.properties.acem_id:e.target.feature.properties.stp_id;if(layers.display.getLayers().length>0&&_featureInDisplay(r)&&(a=$.extend({},e.target.feature)),_resetLayers(!1),!toggleObj.emet_connex&&"all"==toggleObj.emet_hub_or_training_site&&null!==layers.connex.raw){var i=!1;for(var o in layers.connex.raw.features){var s=(_=layers.connex.raw.features[o]).properties.stp_id,l=e.target.feature.properties.stp_id,n=t,c=_.properties.linked_hub_id,p=_.properties.secondary_hub_acem_id,d=_.properties.hub_id,u=_.properties.historical;if("site"==n){if(s==l||c==l||p==l){var g={type:"FeatureCollection",features:[_]};u&&(i=u),layers.connex.layer.addData(g)}}else if((c==l||p==l)&&l==d){g={type:"FeatureCollection",features:[_]};u&&(i=u),layers.connex.layer.addData(g)}}}for(var h in i?_showHistoricalLegend():_hideHistoricalLegend(),layers.stp_data.raw.features)if("all"==toggleObj.emet_hub_or_training_site){var _=layers.stp_data.raw.features[h];if($.inArray(_.properties.hospital_name,linkDict[e.target.feature.properties.stp_id])>-1||$.inArray(_.properties.hospital_name,histLinkDict[e.target.feature.properties.stp_id])>-1){g={type:"FeatureCollection",features:a?[_,a]:[_]};layers.display.addData(g)}else if(e.target.feature.properties.linked_hub_id==_.properties.stp_id||e.target.feature.properties.secondary_hub_id==_.properties.stp_id||e.target.feature.properties.historical_hub_id==_.properties.stp_id){g={type:"FeatureCollection",features:a?[_,a]:[_]};layers.display.addData(g)}}layers.display.eachLayer(function(e){e.bindLabel(e.feature.properties.hospital_name.titleCase().replace(/([\w\s]{20,}?)\s?\b/g,"$1\n"),{noHide:!0,opacity:1,pane:"popupPane",direction:"auto"}).showLabel();var t=e.feature.properties.type||"hub",a=colours[e.feature.properties.program][t];"site"==t&&$(e.label._container).addClass("site-label"),"hub"==t&&$(e.label._container).addClass("hub-label"),isIE?(console.log("ie detected, applying colour"),$(e.label._container).css("color",a)):console.log("Not ie")}),slid||($("#sidebar-content").toggle("slide",{direction:"right"}).css("opacity","1"),slid=!0),e.target.bindLabel(e.target.feature.properties.hospital_name.titleCase().replace(/([\w\s]{20,}?)\s?\b/g,"$1\n"),{noHide:!0,opacity:1,pane:"popupPane",direction:"auto"}).showLabel();var f=e.target.feature.properties.type||"hub",b=colours[e.target.feature.properties.program][f];isIE?(console.log("ie detected, applying colour"),$(e.target.label._container).css("color",b)):console.log("Not ie");var y=e.target.feature.properties.program+"-label";"site"==e.target.feature.properties.type&&(y+="-site"),$(e.target.label._container).addClass(y)},filterFeatures=function(e,t,a,r,i,o,s,l,n,c){var p;p="id"==e?"#":"class"==e?".":null===e?"":"#",c?$(p+t).change(function(){filterExec($(this).prop(i),a,r,i,o,s,l,n,c)}):$(p+t).click(function(){filterExec($(this).prop(i),a,r,i,o,s,l,n,c)})},filterExec=function(e,t,a,r,i,o,s,l,n){l&&("all"!=e||toggleObj[a]?"none"==e&&($(this).prop(r,"all"),toggleObj[a]=!1):($(this).prop(r,"none"),toggleObj[a]=!0)),("connex"!=e&&"emet_hub_or_training_site"==t||"historical"===t)&&(toggleObj.emet_connex=!1),"historical"===t&&_showHistoricalLegend(),"historical"!==t&&_hideHistoricalLegend(),"connex"!=e||toggleObj.emet_connex||(layers.connex.layer.setStyle(function(e){return toggleObj.state&&toggleObj.state!=e.properties.state?{opacity:0}:{opacity:1}}),e="all",toggleObj.emet_connex=!0),"emet_hub_or_training_site"==t&&"connex"!=e&&(toggleObj[t]=e),"historical"==t?(toggleObj[t]="Y",toggleObj.emet_hub_or_training_site="all"):"state"!=t&&(toggleObj.historical=null),"state"==t&&(slid&&($("#sidebar-content").toggle("slide",{direction:"right"}),slid=!1),"all"!=e?toggleObj[t]=e:delete toggleObj[t]),"program"==t&&(slid&&($("#sidebar-content").toggle("slide",{direction:"right"}),slid=!1),"all"!=e?toggleObj[t]=e:delete toggleObj[t]),console.log("filtering by: ",t),console.log("all filters: ",toggleObj),_filterData(!0,!0),o&&_reindexFeatures(layers.stp_data.filtering,["hospital_name","suburb","state"]),_resetLayers(),s&&layers.stp_data.filtering.features.length>0&&layers.stp_data.filtering.features.length<layers.stp_data.raw.features.length?map.fitBounds(layers.stp_data.layer.getBounds(),{padding:[100,100]}):map.fitBounds(presetBounds.all),toggleObj!==toggleInit?$(".clear-control").css("display","block"):$(".clear-control").css("display","none")};function _resetLayers(e){(e=void 0===e||e)?(layers.stp_data.layer.clearLayers(),layers.connex.layer&&layers.connex.layer.clearLayers(),layers.display.clearLayers(),layers.stp_data.filtering?layers.stp_data.layer.addData(layers.stp_data.filtering):layers.stp_data.layer.addData(layers.stp_data.raw),layers.connex.filtering?layers.connex.layer.addData(layers.connex.filtering):layers.connex.raw&&layers.connex.layer.addData(layers.connex.raw)):(layers.connex.layer&&layers.connex.layer.clearLayers(),layers.display.clearLayers(),layers.connex.filtering?layers.connex.layer.addData(layers.connex.filtering):layers.connex.layer&&layers.connex.layer.addData(layers.connex.raw))}function _reindexFeatures(e,t){searchControl.indexFeatures(e,t)}function _featFilter(e,t){var a=[];for(var r in toggleObj){var i=toggleObj[r];"emet_connex"==r&&"points"==this||("emet_hub_or_training_site"==r&&"connex"==this||("emet_hub_or_training_site"==r&&"all"==i?a.push(!0):"emet_connex"==r&&i?a.push(!0):"emet_hub_or_training_site"==r&&"all"==i?a.push(!0):"emet_hub_or_training_site"!=r||e.properties[r]||i!=e.properties.type?"historical"==r&&"Y"==i?a.push(!0):i==e.properties[r]?a.push(!0):a.push(!1):a.push(!0)))}return a=!(a.indexOf(!1)>-1)}function _filterData(e,t){if(e)if(layers.stp_data.filtering={},layers.stp_data.filtering={type:"FeatureCollection",features:layers.stp_data.raw.features.filter(_featFilter,"points")},console.log("points filtered: ",layers.stp_data.filtering.features.length+" of "+layers.stp_data.raw.features.length),layers.stp_data.filtering.features.length<1){$("#no-hospitals").css("display","block").html("Sorry, no hospitals found for the requested filters.")}else $("#no-hospitals").css("display","none");t&&null!=layers.connex.raw&&(layers.connex.filtering={},layers.connex.filtering={type:"FeatureCollection",features:layers.connex.raw.features.filter(_featFilter,"connex")},console.log("connections filtered: ",layers.connex.filtering.features.length+" of "+layers.connex.raw.features.length))}var _sitesAndHubs=function(e){return e.filter(function(e){return"site"==e.properties.type})>0&&e.filter(function(e){return"site"==e.properties.type})>0},getCartoJSON=function(e,t,a,r,i){r=r||"SELECT * FROM "+t,t="stp_data"!==t&&"connex"!==t?"stp_data":t,$.getJSON("https://"+e+".carto.com/api/v2/sql/?q="+r+"&format=geojson",function(e){if(e.features.length>0&&e.features[0].geometry&&"Point"==e.features[0].geometry.type)layers[i].raw=e,_filterData(!0,!1),layers[i].layer=new emetGeoJSON(layers[i].filtering),searchControl.indexFeatures(layers[i].filtering,["hospital_name","suburb","state"]),layers[i].layer.addTo(a);else if(e.features.length>0&&e.features[0].geometry&&"LineString"==e.features[0].geometry.type){var t=JSON.stringify((new Date).getFullYear()).substring(2);layers[i].raw=e,layers[i].layer=new emetGeoJSON({type:"FeatureCollection",features:[]},{style:_lineStyle,attribution:"© 2017-"+t+" <a href='https://www.acem.org.au/' target='blank'>ACEM</a>"}).addTo(a),_filterData(!1,!0)}else $("label.connex-filter").siblings("br").remove(),$(".connex-filter").remove(),connexReceived=!0}).done(function(){(layers.stp_data.layer&&layers.connex.layer||layers.stp_data.layer&&connexReceived)&&(console.log("...Data received"),presetBounds.all=layers.stp_data.layer.getBounds(),a.fitBounds(presetBounds.all),a.spin(!1),_sitesAndHubs(layers.stp_data.raw.features)&&($("input[value='hub'][type='radio'][name='point-filter']").remove(),$("label#hub-filter").remove()))})},createMap=function(){var e=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png",{attribution:"&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"});(map=new L.Map("map",{layers:[e],zoomControl:!1}).on("click",function(){slid&&($("#sidebar-content").toggle("slide",{direction:"right"}),slid=!1),!toggleObj.historical&&$(".legend-historical").css("display","table-row")&&_hideHistoricalLegend(),_resetLayers()})).spin(!0),searchControl.options.mapObj=map,searchControl.addTo(map),L.control.zoom({position:"bottomleft"}).addTo(map);var t="";t+="<h3>Layers</h3>",t+="<input type='radio' name='point-filter' value='hub' class='hubs'> <label id='hub-filter'>STP Hubs<br></label>",t+="<input type='radio' name='point-filter' id='def' value='all' checked class='hubs'> <label id='all-filter'>All Hubs and Training Sites</label><br>",t+="<input type='radio' name='point-filter' class='connex-filter hubs' value='connex'> <label class='connex-filter' id='connex-filter'>STP Hubs and Training Sites with connections</label><br>",(featureControl=new EmetControl({position:"topleft"})).htmlString=t,featureControl.addTo(map),featureControl.getContainer().className+=" feature-control",filterFeatures(null,"input[type='radio'][name='point-filter'].hubs","emet_hub_or_training_site","stp_data","value",!0,!0,!0,!1,!0),filterFeatures(null,"input[type='radio'][name='point-filter'].historical","historical","stp_data","value",!0,!0,!0,!1,!0),stateControl=new EmetControl({position:"topleft"});var a="";a+="<a href='#' id='all' class='dropdown-selection state-selector'>Show all states</a>",a+="<a href='#' id='NSW' class='dropdown-selection state-selector'>NSW & ACT</a>",a+="<a href='#' id='NT' class='dropdown-selection state-selector'>NT</a>",a+="<a href='#' id='QLD' class='dropdown-selection state-selector'>QLD</a>",a+="<a href='#' id='SA' class='dropdown-selection state-selector'>SA</a>",a+="<a href='#' id='TAS' class='dropdown-selection state-selector'>TAS</a>",a+="<a href='#' id='VIC' class='dropdown-selection state-selector'>VIC</a>",a="<div class='dropdown-content'>"+(a+="<a href='#' id='WA' class='dropdown-selection state-selector'>WA</a>")+"</div>",a="<div class='dropdown'>"+(a="<h3 class='dropdown-label'>State</h3>"+(a="<button class='dropbtn'>"+sidebarText.state.buttonInitial+"</button>"+a))+"</div>",stateControl.htmlString=a,stateControl.addTo(map),stateControl.getContainer().className+=" state-control",filterFeatures("class","state-selector","state","stp_data","id",!0,!0,!0,!1,!1),programControl=new EmetControl({position:"topleft"});var r="";r+="<a href='#' id='all' class='dropdown-selection program-selector'>Show all</a>",r+="<a href='#' id='STPS' class='dropdown-selection program-selector'>STPS</a>",r+="<a href='#' id='IRTP' class='dropdown-selection program-selector'>IRTP</a>",r+="<a href='#' id='EDPSCS' class='dropdown-selection program-selector'>EDPSCS</a>",r="<div class='dropdown-content'>"+(r+="<a href='#' id='TAS' class='dropdown-selection program-selector'>TAS</a>")+"</div>",r="<div class='dropdown'>"+(r="<h3 class='dropdown-label'>Program</h3>"+(r="<button class='dropbtn'>"+sidebarText.program.buttonInitial+"</button>"+r))+"</div>",programControl.htmlString=r,programControl.addTo(map),programControl.getContainer().className+=" program-control",filterFeatures("class","program-selector","program","stp_data","id",!0,!0,!0,!1,!1);var i=new EmetControl({position:"topleft"});i.htmlString="<a href='#' id='clear' class='dropdown-selection program-selector'>✕ Clear</a>",i.addTo(map),i.getContainer().className+=" clear-control",$(".clear-control").css("display","none"),$("#clear").click(function(){$(".state-control").children(".dropdown").children(".dropbtn").html(sidebarText.state.buttonInitial),$(".program-control").children(".dropdown").children(".dropbtn").html(sidebarText.program.buttonInitial),$("input[name=point-filter]").prop("checked",!1),$("#def").prop("checked",!0),toggleObj=$.extend({},toggleInit),_filterData(!0,!0),_resetLayers(!0),map.fitBounds(presetBounds.all),$(this).parent(".clear-control").css("display","none")});var o=new EmetControl({position:"topleft"});o.htmlString='<input id="labelToggle" type="checkbox" checked class="on">Labels</input>',o.addTo(map),o.getContainer().className+=" label-control",$("#labelToggle").change(function(){if($(this).hasClass("on")){$(this).toggleClass("on");var e=$('<style class="hack-style">.leaflet-label { display: none; }</style>');$("html > head").append(e)}else $(this).toggleClass("on"),$(".hack-style").remove()}),$(".dropdown").click(function(){"none"==$(this).children(".dropdown-content").css("display")?$(this).children(".dropdown-content").show():$(this).children(".dropdown-content").hide()}),$(".dropdown-selection").click(function(){$(this).parent().parent().children(".dropbtn").html("Showing: "+$(this).prop("id"))}),console.log("Getting data...");getCartoJSON(account,"stp_data_output_180530",map,void 0,"stp_data"),getCartoJSON(account,"stp_data_output_180530",map,"SELECT ed.stp_id as stp_id, ed.linked_hub_id as linked_hub_id, ed.program as program, ST_GeomFromGeoJSON(CONCAT('{\"type\":\"LineString\",\"coordinates\":[[',ed.long, ', ', ed.lat,'],[',ec.long, ', ', ec.lat,']] }')) as the_geom, ec.stp_id as hub_id, ed.state as state FROM stp_data_output_180530 ed JOIN stp_data_output_180530 ec ON ed.linked_hub_id = ec.stp_id","connex");layers.display=new emetGeoJSON({type:"FeatureCollection",features:[]}).addTo(map)};window.onload=createMap;var sidebarText={contact:"For more information on this  program, contact:",site:{heading:"Serviced by:",historical:"Formerly serviced by:"},hub:{heading:"Servicing hospitals:",historical:"Formerly servicing hospitals:"},state:{buttonInitial:"Filter by state        &#x25BC;"},program:{buttonInitial:"Filter by program        &#x25BC;"}};